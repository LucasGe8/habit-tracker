{% extends 'base.html' %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <h2>Mis H√°bitos</h2>
    <a href="{% url 'habit_create' %}" class="btn">+ Nuevo H√°bito</a>
</div>

<div class="habit-grid">
    {% for habit in habits %}
    <div class="habit-card {% if habit.today_log and habit.today_log.value >= habit.target %}completed{% endif %}">
        <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 0.5rem;">
            <h3 style="flex: 1; margin-right: 1rem;">{{ habit.name }}</h3>
            <div style="text-align: right;">
                <div class="streak">üî• {{ habit.current_streak }}</div>
                <!-- Temporizador individual para cada racha -->
                <div class="individual-timer" data-habit-id="{{ habit.id }}" 
                     style="font-size: 0.7rem; margin-top: 0.2rem; font-family: monospace;">
                    {% if habit.is_completed_today %}
                        <span style="color: #28a745;">‚úÖ Hoy completado</span>
                    {% else %}
                        {% with habit.hours_until_midnight as time_left %}
                        <span style="color: #ffc107;">‚è≥ {{ time_left.0 }}h {{ time_left.1 }}m</span>
                        {% endwith %}
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
            <span style="font-size: 0.8rem; color: #888;">
                Creado el {{ habit.formatted_created_at }}
            </span>
            <span style="font-size: 0.8rem; color: #007bff; background: rgba(0,123,255,0.1); padding: 0.2rem 0.5rem; border-radius: 10px;">
                {{ habit.get_goal_type_display }}
            </span>
        </div>
        
        <div style="margin-bottom: 1rem; font-size: 0.9rem; color: #ccc;">
            {% if habit.goal_type == 'boolean' %}
                Meta: Completar diariamente
            {% else %}
                Meta: {{ habit.target }} {% if habit.goal_type == 'time' %}minutos{% else %}unidades{% endif %}
            {% endif %}
        </div>
        
        <div style="display: flex; gap: 0.5rem;">
            {% if habit.today_log and habit.today_log.value >= habit.target %}
                <form method="post" action="{% url 'log_habit' habit.id %}" style="flex: 1;">
                    {% csrf_token %}
                    <input type="hidden" name="value" value="0">
                    <button type="submit" class="btn btn-outline" style="width: 100%;">
                        ‚úÖ Completado
                    </button>
                </form>
            {% else %}
                {% if habit.goal_type == 'boolean' %}
                    <form method="post" action="{% url 'log_habit' habit.id %}" style="flex: 1;">
                        {% csrf_token %}
                        <input type="hidden" name="value" value="1">
                        <button type="submit" class="btn" style="width: 100%;">
                            Marcar Completado
                        </button>
                    </form>
                {% else %}
                    <form method="post" action="{% url 'log_habit' habit.id %}" style="display: flex; gap: 0.5rem; width: 100%;">
                        {% csrf_token %}
                        <input type="number" name="value" class="form-control" placeholder="Valor" 
                               step="{% if habit.goal_type == 'time' %}1{% else %}0.1{% endif %}" 
                               style="flex: 2;">
                        <button type="submit" class="btn" style="flex: 1;">Guardar</button>
                    </form>
                {% endif %}
            {% endif %}
            
            <!-- BOTONES DE ACCI√ìN -->
            <div style="display: flex; gap: 0.25rem;">
                <a href="{% url 'habit_edit' habit.id %}" class="btn btn-outline" style="padding: 0.5rem;">‚úèÔ∏è</a>
                <!-- NUEVO: Bot√≥n de eliminar -->
                <button type="button" class="btn btn-outline" style="padding: 0.5rem; color: #dc3545;" 
                        onclick="confirmDelete({{ habit.id }}, '{{ habit.name|escapejs }}')">üóëÔ∏è</button>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="card" style="text-align: center; padding: 2rem;">
        <h3>No tienes h√°bitos registrados</h3>
        <p style="margin: 1rem 0; color: #ccc;">Comienza creando tu primer h√°bito</p>
        <a href="{% url 'habit_create' %}" class="btn">Crear Primer H√°bito</a>
    </div>
    {% endfor %}
</div>

<!-- Script para actualizar los temporizadores individuales -->
<script>
function updateIndividualTimers() {
    const now = new Date();
    const tomorrow = new Date(now);
    tomorrow.setDate(tomorrow.getDate() + 1);
    tomorrow.setHours(0, 0, 0, 0);
    
    const timeLeft = tomorrow - now;
    
    const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
    
    // Actualizar todos los temporizadores individuales
    const timerElements = document.querySelectorAll('.individual-timer');
    
    timerElements.forEach(timer => {
        // Solo actualizar si no est√° marcado como completado
        if (!timer.querySelector('span').textContent.includes('completado')) {
            let color = '#28a745'; // Verde por defecto
            
            if (hours < 4) {
                color = '#dc3545'; // Rojo cuando quedan menos de 4 horas
            } else if (hours < 8) {
                color = '#ffc107'; // Amarillo cuando quedan menos de 8 horas
            }
            
            timer.innerHTML = `<span style="color: ${color};">‚è≥ ${hours.toString().padStart(2, '0')}h ${minutes.toString().padStart(2, '0')}m</span>`;
        }
    });
}

// NUEVO: Funci√≥n para confirmar eliminaci√≥n
function confirmDelete(habitId, habitName) {
    if (confirm(`¬øEst√°s seguro de que quieres eliminar el h√°bito "${habitName}"? Esta acci√≥n no se puede deshacer.`)) {
        // Crear un formulario din√°mico para enviar la solicitud POST
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/habit/${habitId}/delete/`;
        
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken;
        
        form.appendChild(csrfInput);
        document.body.appendChild(form);
        form.submit();
    }
}

// Actualizar cada minuto (no necesita ser en tiempo real exacto)
updateIndividualTimers();
setInterval(updateIndividualTimers, 60000); // Actualizar cada minuto
</script>
{% endblock %}