{% extends 'base.html' %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <h2>Mis H√°bitos</h2>
    <a href="{% url 'habit_create' %}" class="btn">+ Nuevo H√°bito</a>
</div>

<div class="habit-grid">
    {% for habit in habits %}
    <div class="habit-card {% if habit.today_log and habit.today_log.value >= habit.target and not habit.today_log.excluded %}completed{% endif %} 
                {% if habit.today_log and habit.today_log.excluded %}excluded{% endif %}" 
         id="habit-{{ habit.id }}">
        <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 0.5rem;">
            <h3 style="flex: 1; margin-right: 1rem;">{{ habit.name }}</h3>
            <div style="text-align: right;">
                <div class="streak">üî• {{ habit.current_streak }}</div>
                <div class="individual-timer" data-habit-id="{{ habit.id }}" 
                     style="font-size: 0.7rem; margin-top: 0.2rem; font-family: monospace;">
                    {% if habit.today_log and habit.today_log.excluded %}
                        <span style="color: #6c757d;">‚è∏Ô∏è D√≠a excluido</span>
                    {% elif habit.is_completed_today %}
                        <span style="color: #28a745;">‚úÖ Hoy completado</span>
                    {% else %}
                        {% with habit.hours_until_midnight as time_left %}
                        <span style="color: #ffc107;">‚è≥ {{ time_left.0 }}h {{ time_left.1 }}m</span>
                        {% endwith %}
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
            <span style="font-size: 0.8rem; color: #888;">
                Creado el {{ habit.formatted_created_at }}
            </span>
            <span style="font-size: 0.8rem; color: #007bff; background: rgba(0,123,255,0.1); padding: 0.2rem 0.5rem; border-radius: 10px;">
                {{ habit.get_goal_type_display }}
            </span>
        </div>
        
        <div style="margin-bottom: 1rem; font-size: 0.9rem; color: #ccc;">
            {% if habit.goal_type == 'boolean' %}
                Meta: Completar diariamente
            {% else %}
                Meta: {{ habit.target }} {% if habit.goal_type == 'time' %}minutos{% else %}unidades{% endif %}
            {% endif %}
        </div>
        
        <div style="display: flex; gap: 0.5rem;">
            {% if habit.today_log and habit.today_log.excluded %}
                <!-- Estado: D√≠a excluido -->
                <div style="flex: 1; text-align: center; padding: 0.75rem; background: #6c757d; color: white; border-radius: 5px;">
                    ‚è∏Ô∏è D√≠a excluido
                </div>
                <form method="post" action="{% url 'log_habit' habit.id %}" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="value" value="1">
                    <button type="submit" class="btn btn-outline" style="padding: 0.5rem;" title="Reactivar d√≠a">
                        üîÑ
                    </button>
                </form>
            {% elif habit.today_log and habit.today_log.value >= habit.target and not habit.today_log.excluded %}
                <!-- Estado: Completado - Mostrar bot√≥n de exclusi√≥n -->
                <form method="post" action="{% url 'exclude_day' habit.id %}" style="flex: 1;" onsubmit="return confirmExclude({{ habit.id }}, {{ habit.current_streak }});">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline" style="width: 100%; color: #6c757d;">
                        ‚è∏Ô∏è Excluir Hoy
                    </button>
                </form>
            {% else %}
                <!-- Estado: No completado - Comportamiento normal -->
                {% if habit.goal_type == 'boolean' %}
                    <form method="post" action="{% url 'log_habit' habit.id %}" style="flex: 1;">
                        {% csrf_token %}
                        <input type="hidden" name="value" value="1">
                        <button type="submit" class="btn" style="width: 100%;">
                            Marcar Completado
                        </button>
                    </form>
                {% else %}
                    <div style="display: flex; gap: 0.5rem; width: 100%; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; flex: 1; background: #2a2a2a; border-radius: 8px; padding: 0.5rem;">
                            <button type="button" class="btn btn-outline decrement-btn" 
                                    data-habit-id="{{ habit.id }}" 
                                    style="padding: 0.5rem; min-width: 40px;">-</button>
                            
                            <div style="text-align: center; flex: 1;">
                                <div id="value-{{ habit.id }}" class="habit-value" 
                                     style="font-size: 1.2rem; font-weight: bold; color: #007bff;">
                                    {{ habit.today_log.value|default:0|floatformat:0 }}
                                </div>
                                <div style="font-size: 0.7rem; color: #888;">
                                    de {{ habit.target|floatformat:0 }}
                                </div>
                            </div>
                            
                            <button type="button" class="btn btn-outline increment-btn" 
                                    data-habit-id="{{ habit.id }}" 
                                    style="padding: 0.5rem; min-width: 40px;">+</button>
                        </div>
                        
                        <button type="button" class="btn save-btn" 
                                data-habit-id="{{ habit.id }}" 
                                style="flex: 0.5; display: none;">üíæ</button>
                    </div>
                {% endif %}
            {% endif %}
            
            <!-- Botones de acci√≥n -->
            <div style="display: flex; gap: 0.25rem;">
                <a href="{% url 'habit_edit' habit.id %}" class="btn btn-outline" style="padding: 0.5rem;">‚úèÔ∏è</a>
                <button type="button" class="btn btn-outline" style="padding: 0.5rem; color: #dc3545;" 
                        onclick="confirmDelete({{ habit.id }}, '{{ habit.name|escapejs }}')">üóëÔ∏è</button>
            </div>
        </div>
        
        <!-- Barra de progreso -->
        {% if habit.goal_type != 'boolean' and not habit.today_log.excluded %}
        <div style="margin-top: 0.5rem; background: #333; border-radius: 4px; height: 6px; overflow: hidden;">
            <div id="progress-{{ habit.id }}" class="progress-bar" 
                 style="height: 100%; background: #007bff; width: 
                 {% widthratio habit.today_log.value|default:0 habit.target 100 %}%; 
                 transition: width 0.3s ease;">
            </div>
        </div>
        {% endif %}
    </div>
    {% empty %}
    <div class="card" style="text-align: center; padding: 2rem;">
        <h3>No tienes h√°bitos registrados</h3>
        <p style="margin: 1rem 0; color: #ccc;">Comienza creando tu primer h√°bito</p>
        <a href="{% url 'habit_create' %}" class="btn">Crear Primer H√°bito</a>
    </div>
    {% endfor %}
</div>

<!-- Scripts existentes... -->
<script>
// Variables globales para almacenar valores temporales y timeouts por h√°bito
const habitValues = {};
const saveTimeouts = {};

// Seguridad en timers individuales
function updateIndividualTimers() {
    const now = new Date();
    const tomorrow = new Date(now);
    tomorrow.setDate(tomorrow.getDate() + 1);
    tomorrow.setHours(0, 0, 0, 0);
    
    const timeLeft = tomorrow - now;
    const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
    
    const timerElements = document.querySelectorAll('.individual-timer');
    
    timerElements.forEach(timer => {
        const span = timer.querySelector('span');
        if (!span) return;
        if (!span.textContent.toLowerCase().includes('completado') && !span.textContent.toLowerCase().includes('excluido')) {
            let color = '#28a745';
            if (hours < 4) color = '#dc3545';
            else if (hours < 8) color = '#ffc107';
            timer.innerHTML = `<span style="color: ${color};">‚è≥ ${hours.toString().padStart(2, '0')}h ${minutes.toString().padStart(2, '0')}m</span>`;
        }
    });
}

function initializeNumericHabits() {
    // Inicializar valores y leer target desde data-attributes (si est√°n)
    document.querySelectorAll('.habit-value').forEach(element => {
        const habitId = element.id.split('-')[1];
        habitValues[habitId] = parseFloat(element.textContent) || 0;
        if (!element.dataset.target) element.dataset.target = element.getAttribute('data-target') || '0';
    });

    document.querySelectorAll('.increment-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const habitId = this.getAttribute('data-habit-id');
            incrementValue(habitId);
        });
    });

    document.querySelectorAll('.decrement-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const habitId = this.getAttribute('data-habit-id');
            decrementValue(habitId);
        });
    });

    document.querySelectorAll('.save-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const habitId = this.getAttribute('data-habit-id');
            saveValue(habitId);
        });
    });
}

function incrementValue(habitId) {
    if (!habitValues.hasOwnProperty(habitId)) return;
    habitValues[habitId]++;
    updateDisplay(habitId);
    // Auto-guardar por h√°bito
    clearTimeout(saveTimeouts[habitId]);
    saveTimeouts[habitId] = setTimeout(() => saveValue(habitId), 1000);
}

function decrementValue(habitId) {
    if (!habitValues.hasOwnProperty(habitId)) return;
    habitValues[habitId]--;
    if (habitValues[habitId] < 0) habitValues[habitId] = 0;
    updateDisplay(habitId);
    clearTimeout(saveTimeouts[habitId]);
    saveTimeouts[habitId] = setTimeout(() => saveValue(habitId), 2000);
}

function updateDisplay(habitId) {
    const valueElement = document.getElementById(`value-${habitId}`);
    const progressElement = document.getElementById(`progress-${habitId}`);
    const target = parseFloat(valueElement?.dataset?.target || '0');
    
    if (valueElement) {
        valueElement.textContent = habitValues[habitId];
    }
    
    if (progressElement && target > 0) {
        const progress = Math.min((habitValues[habitId] / target) * 100, 100);
        progressElement.style.width = `${progress}%`;
        if (progress >= 100) progressElement.style.background = '#28a745';
        else if (progress >= 75) progressElement.style.background = '#17a2b8';
        else progressElement.style.background = '#007bff';
    }
    checkCompletion(habitId);
}

function showSaveButton(habitId) {
    const saveBtn = document.querySelector(`.save-btn[data-habit-id="${habitId}"]`);
    if (saveBtn) saveBtn.style.display = 'block';
}

function checkCompletion(habitId) {
    const value = habitValues[habitId];
    const valueElement = document.getElementById(`value-${habitId}`);
    const target = parseFloat(valueElement?.dataset?.target || '0');
    const habitCard = document.getElementById(`habit-${habitId}`);
    
    if (value >= target && habitCard) habitCard.classList.add('completed');
    else if (habitCard) habitCard.classList.remove('completed');
}

function saveValue(habitId) {
    const value = habitValues[habitId];
    const csrfTokenEl = document.querySelector('[name=csrfmiddlewaretoken]');
    const csrfToken = csrfTokenEl ? csrfTokenEl.value : '';
    
    fetch(`/log/${habitId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfToken
        },
        body: `value=${encodeURIComponent(value)}`
    })
    .then(response => {
        if (response.ok) {
            const saveBtn = document.querySelector(`.save-btn[data-habit-id="${habitId}"]`);
            if (saveBtn) saveBtn.style.display = 'none';
            showMessage('¬°Registro guardado!', 'success');
            setTimeout(() => location.reload(), 800);
        } else {
            showMessage('Error al guardar', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Error al guardar', 'error');
    })
    .finally(() => {
        clearTimeout(saveTimeouts[habitId]);
    });
}

function showMessage(message, type) {
    const messageDiv = document.createElement('div');
    messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem;
        border-radius: 5px;
        color: white;
        z-index: 10000;
        background: ${type === 'success' ? '#28a745' : '#dc3545'};
    `;
    messageDiv.textContent = message;
    document.body.appendChild(messageDiv);
    setTimeout(() => messageDiv.remove(), 3000);
}

function confirmDelete(habitId, habitName) {
    if (confirm(`¬øEst√°s seguro de que quieres eliminar el h√°bito "${habitName}"? Esta acci√≥n no se puede deshacer.`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/habit/${habitId}/delete/`;
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);
        document.body.appendChild(form);
        form.submit();
    }
}

// NUEVO: Funci√≥n para confirmar exclusi√≥n
function confirmExclude(habitId, streak) {
    return confirm(`¬øExcluir hoy sin afectar tu racha de ${streak} d√≠as?\n\nEl d√≠a se marcar√° como excluido y no afectar√° tu racha.`);
}

document.addEventListener('DOMContentLoaded', function() {
    updateIndividualTimers();
    initializeNumericHabits();
    setInterval(updateIndividualTimers, 60000);
});
</script>
{% endblock %}